package de.dailab.newsreel.recommender.common.extimpl.unit.extimpl;

import de.dailab.newsreel.recommender.common.item.PlistaItem;
import org.junit.Before;
import org.junit.Test;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertThat;

/**
 * Created by domann on 11.12.15.
 */
public class PlistaItemTest {

    protected String plistaJsonImpression;
    protected String plistaJsonImpressionEmpty;
    protected String plistaJsonClick;
    protected String plistaJsonRecommendation;

    @Before
    public void setUp() throws Exception {
        plistaJsonImpression = "{\"type\":\"impression\",\"context\":{\"simple\":{\"57\":37002485394733859,\"89\":0," +
                "\"27\":35774,\"7\":2878801,\"25\":256265747,\"29\":17332,\"85\":10,\"4\":16119373,\"56\":1138207," +
                "\"63\":1840689,\"38\":16055832,\"62\":1788882,\"83\":50,\"77\":140,\"52\":1,\"14\":6576010," +
                "\"39\":26605,\"68\":1851468,\"16\":48811,\"88\":10,\"91\":2864860,\"96\":0,\"42\":0,\"106\":16200408," +
                "\"81\":2101340,\"24\":9,\"84\":23075076388543156,\"44\":1902613,\"82\":2255070,\"47\":504182," +
                "\"75\":16016156,\"6\":521468,\"74\":1919992,\"17\":48985,\"61\":658577702559789137,\"15\":15807917," +
                "\"22\":72326,\"31\":0,\"5\":6,\"67\":1928642,\"13\":2,\"9\":26885,\"23\":10,\"49\":21," +
                "\"97\":1453367910,\"80\":658,\"37\":17266838,\"98\":3232180,\"59\":1275566,\"110\":16458021," +
                "\"18\":5},\"lists\":{\"26\":[],\"8\":[18841,18842],\"11\":[81565]},\"clusters\":{\"33\":{\"38425\":8," +
                "\"3977104\":5,\"269062\":4,\"35054\":4,\"160689\":3,\"402633\":3,\"689403\":3,\"135948\":3," +
                "\"83877\":3,\"158070\":3,\"33396\":3,\"20410\":3,\"18811760\":3,\"22881\":3,\"46846\":2,\"365\":2," +
                "\"294082\":2,\"576264\":1,\"9771\":1,\"22691\":1,\"1632\":1,\"2934618\":1,\"16911\":0,\"7281\":0}," +
                "\"51\":{\"1\":255},\"65\":{\"1\":255},\"64\":{\"1\":255},\"66\":{\"12\":255}}},\"recs\":{\"ints\":" +
                "{\"3\":[256250168,256149408,256118512,254257884,255042004]}},\"timestamp\":1453367910775}";

        plistaJsonImpressionEmpty = "{\"type\":\"impression_empty\",\"context\":{\"simple\":{\"89\":0,\"27\":1677," +
                "\"7\":2878799,\"25\":255734646,\"57\":36578551875052132,\"29\":17332,\"85\":7,\"4\":1289660," +
                "\"56\":1138207,\"63\":1840689,\"38\":16055832,\"52\":1,\"16\":48811,\"88\":10,\"91\":2864860," +
                "\"96\":0,\"42\":0,\"106\":16200408,\"81\":2101340,\"24\":9,\"84\":21057599529416321,\"108\":16125607," +
                "\"44\":1902613,\"82\":0,\"47\":654013,\"75\":1919903,\"6\":10,\"74\":1919860,\"17\":48985," +
                "\"61\":507200256123119137,\"15\":15807917,\"22\":1453832,\"31\":0,\"5\":1019576,\"67\":1928642," +
                "\"13\":2,\"9\":26885,\"23\":10,\"49\":21,\"97\":1453367910,\"80\":750,\"37\":17266838,\"98\":3232180," +
                "\"59\":1275566,\"110\":16458021},\"lists\":{\"26\":[],\"8\":[18841,18842,48511]," +
                "\"10\":[1763,1765,1768,1769,1770,1774]},\"clusters\":{\"33\":{\"33442233\":7," +
                "\"854689\":7,\"9424\":7,\"2442515\":6,\"8081\":5,\"53348\":5,\"117413\":4,\"208661\":3," +
                "\"33693713\":3,\"33454203\":3,\"83840\":2,\"488102\":2,\"38861761\":2,\"7049282\":2,\"107761\":2," +
                "\"73617\":2,\"2296637\":2,\"16505\":2,\"7493201\":1,\"8835\":1,\"2127309\":1,\"35021\":1,\"17527\":1," +
                "\"16911\":0},\"2\":[11,11,61,60,61,26,21],\"51\":{\"3\":255},\"1\":[185],\"3\":[55,28,34,91,23,21]," +
                "\"65\":{\"1\":255},\"64\":{\"2\":255},\"66\":{\"11\":255}}},\"recs\":null,\"timestamp\":1453367911104}";

        plistaJsonClick = "{\"type\":\"click\",\"context\":{\"simple\":{\"4\":16059339,\"5\":6,\"6\":431209," +
                "\"7\":2862848,\"9\":26885,\"13\":2,\"14\":33331,\"15\":15807917,\"16\":48811,\"17\":48985,\"18\":5," +
                "\"20\":90,\"22\":70209,\"23\":10,\"24\":0,\"25\":256272802,\"27\":1677,\"29\":17332,\"35\":315003," +
                "\"37\":17266838,\"38\":16055832,\"39\":25495,\"40\":1618697,\"42\":0,\"44\":15945871,\"47\":504183," +
                "\"49\":21,\"52\":0,\"56\":1138207,\"59\":1275566,\"61\":362137119672371522,\"62\":1895712," +
                "\"63\":1840689,\"67\":1928652,\"68\":1853461,\"74\":1920088,\"75\":16016156,\"77\":140," +
                "\"80\":755,\"81\":2101340,\"82\":2584276,\"83\":255,\"84\":53362000850800086,\"85\":7,\"88\":10," +
                "\"89\":0,\"91\":2864860,\"96\":0,\"97\":1453367825,\"98\":3232180,\"104\":16009230,\"106\":16200408," +
                "\"107\":16215212,\"108\":16125607,\"109\":16488847,\"110\":16458021,\"57\":37002485394733900}," +
                "\"lists\":{\"8\":[18841,18842,48511]},\"clusters\":{\"1\":[185],\"2\":[11,11,61,60,61,26,21]," +
                "\"3\":[55,28,34,91,23,21],\"33\":{\"2073855\":9,\"15821\":9,\"19780\":7,\"5337063\":6,\"507639\":5," +
                "\"33719\":5,\"304867\":5,\"731959\":4,\"28346\":4,\"596551\":3,\"2333769\":2,\"17707\":2,\"4074\":2," +
                "\"18732595\":2,\"9234\":2,\"64410\":2,\"16911\":1,\"153529\":1,\"52926\":1,\"10655\":1,\"17527\":0}," +
                "\"51\":{\"1\":255},\"64\":{\"2\":255},\"65\":{\"1\":255},\"66\":{\"11\":255}}}," +
                "\"recs\":{\"ints\":{\"3\":[255734646]}},\"timestamp\":1453367911751}";

        plistaJsonRecommendation = "{\"context\":{\"simple\":{\"89\":0,\"27\":35774,\"7\":2878817,\"25\":256246106," +
                "\"57\":36945795726278459,\"29\":17332,\"85\":10,\"4\":16119373,\"56\":1138207,\"63\":1840689," +
                "\"38\":16055832,\"62\":1791442,\"83\":50,\"77\":0,\"52\":0,\"14\":33331,\"39\":23901,\"68\":1853461," +
                "\"16\":48811,\"88\":10,\"91\":2864860,\"96\":0,\"42\":0,\"106\":16200408,\"81\":2101340,\"24\":3," +
                "\"84\":21181407419464435,\"108\":16125676,\"44\":15944342,\"82\":2246323,\"47\":504182," +
                "\"75\":16016156,\"6\":521468,\"74\":1919992,\"17\":48985,\"40\":1791124,\"35\":315003," +
                "\"61\":348788541292050690,\"15\":15807917,\"22\":122667,\"31\":0,\"5\":1581908,\"67\":1928642," +
                "\"13\":2,\"9\":26885,\"23\":10,\"49\":21,\"97\":1453367929,\"80\":434,\"37\":17266838,\"98\":3232180," +
                "\"59\":1275566,\"110\":16458021,\"107\":16215212,\"109\":16488847,\"41\":43},\"lists\":{\"26\":[]," +
                "\"8\":[18841,18842],\"11\":[81565]},\"clusters\":{\"33\":{\"27076277\":11.04,\"227\":5.89," +
                "\"627451\":5.28,\"29407\":3.21,\"38873923\":2.94,\"103459\":2.93,\"60848\":2.3,\"8299\":2.15," +
                "\"42247\":2.06,\"3471\":2.02,\"11325\":1.96,\"151510\":1.91,\"345\":1.85,\"36816\":1.85," +
                "\"1447\":1.83,\"26598\":1.66,\"117118\":1.56,\"71764\":1.49,\"18611\":1.46,\"275562\":1.37," +
                "\"1097\":1.34,\"41879\":1.27},\"51\":{\"2\":255},\"65\":{\"1\":255},\"64\":{\"1\":255}," +
                "\"66\":{\"12\":255}}},\"limit\":6,\"vectors\":[3]}";

    }

    @Test
    public void whenPlistaItemImpressiopnIsInitialized_thenNoExceptionsAndAllFieldsCorrect() throws Exception {
        PlistaItem item = PlistaItem.parsePlistaRequest(PlistaItem.TYPE_EVENT_NOTIFICATION, plistaJsonImpression);
        assertThat(item.getItemID(), is(256265747L));
        assertThat(item.getDomainId(), is(35774L));
        assertThat(item.getUserID(), is(37002485394733859L));
        assertThat(item.getNumberOfPredictions(), is(Integer.MIN_VALUE));
        assertThat(item.getImpressionType(), is(PlistaItem.EVENT_IMPRESSION));
    }

    @Test
    public void whenPlistaItemImpressiopnEmptyIsInitialized_thenNoExceptionsAndAllFieldsCorrect() throws Exception {
        PlistaItem item = PlistaItem.parsePlistaRequest(PlistaItem.TYPE_EVENT_NOTIFICATION, plistaJsonImpressionEmpty);
        assertThat(item.getItemID(), is(255734646L));
        assertThat(item.getDomainId(), is(1677L));
        assertThat(item.getUserID(), is(36578551875052132L));
        assertThat(item.getNumberOfPredictions(), is(Integer.MIN_VALUE));
        assertThat(item.getImpressionType(), is(PlistaItem.EVENT_IMPRESSION_EMPTY));
    }

    @Test
    public void whenPlistaItemClickIsInitialized_thenNoExceptionsAndAllFieldsCorrect() throws Exception {
        PlistaItem item = PlistaItem.parsePlistaRequest(PlistaItem.TYPE_EVENT_NOTIFICATION, plistaJsonClick);
        assertThat(item.getItemID(), is(256272802L));
        assertThat(item.getDomainId(), is(1677L));
        assertThat(item.getUserID(), is(37002485394733900L));
        assertThat(item.getNumberOfPredictions(), is(Integer.MIN_VALUE));
        assertThat(item.getImpressionType(), is(PlistaItem.EVENT_CLICK));
    }

    @Test
    public void whenPlistaItemRecommendationIsInitialized_thenNoExceptionsAndAllFieldsCorrect() throws Exception {
        PlistaItem item = PlistaItem.parsePlistaRequest(PlistaItem.TYPE_RECOMMENDATION_REQUEST, plistaJsonRecommendation);
        assertThat(item.getItemID(), is(256246106L));
        assertThat(item.getDomainId(), is(35774L));
        assertThat(item.getUserID(), is(36945795726278459L));
        assertThat(item.getNumberOfPredictions(), is(6));
    }

}
